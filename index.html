<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DEEN WAY Ebook</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f7f6f4;
      --card:#ffffff;
      --muted:#7b7f86;
      --accent:#b78f4a; /* elegant gold */
      --accent-2:#7db9a6; /* soft teal alternative */
      --glass: rgba(11,12,14,0.03);
      --shadow: 0 10px 30px rgba(28,32,38,0.06);
      --radius:14px;
      --gap:18px;
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter, system-ui, "Segoe UI", Roboto; background:var(--bg); color:#111;}
    a{color:inherit;text-decoration:none}
    .container{max-width:1200px;margin:28px auto;padding:20px;display:flex;flex-direction:column;gap:20px}

    /* Header */
    .header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      background:linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,0.5));
      padding:18px;
      border-radius:12px;
      box-shadow:var(--shadow);
      border:1px solid rgba(0,0,0,0.04);
    }
    .brand{
      display:flex;
      gap:14px;
      align-items:center;
    }
    .logo{
      width:64px;height:64px;border-radius:12px;display:flex;align-items:center;justify-content:center;
      background:linear-gradient(135deg,var(--accent-2),var(--accent));
      color:#fff;font-weight:700;font-family:'Playfair Display', serif;font-size:20px;
      box-shadow: 0 6px 18px rgba(120,120,120,0.08);
    }
    .titles{ text-align:right; }
    .site-title{
      margin:0;font-family:'Playfair Display', serif;font-size:1.8rem;color:#222;
      letter-spacing:0.6px;
    }
    .site-sub{ margin:0;color:var(--muted);font-size:0.95rem }

    /* controls row (hidden comments only in code) */
    .toolbar{ display:flex; gap:10px; align-items:center; justify-content:flex-start; }

    /* grid */
    .grid-wrap{
      background:transparent;padding:6px;border-radius:12px;
    }
    .books-grid{
      display:grid;
      grid-template-columns:repeat(4, 1fr);
      gap:var(--gap);
    }

    /* book card */
    .card{
      width:100%;
      aspect-ratio:9/12;
      perspective:1200px;
      border-radius:12px;
      cursor:grab;
      -webkit-user-select:none;
      user-select:none;
    }
    .card:active{ cursor:grabbing; }

    .card-inner{
      width:100%;height:100%;position:relative;transform-style:preserve-3d;
      transition:transform .7s cubic-bezier(.2,.9,.2,1);
      border-radius:12px;
    }
    .card:hover .card-inner,
    .card:focus-within .card-inner{ transform:rotateY(180deg); }

    .face{
      position:absolute;inset:0;border-radius:12px;backface-visibility:hidden;overflow:hidden;
      display:flex;flex-direction:column;background:var(--card);box-shadow:var(--shadow);border:1px solid rgba(0,0,0,0.04);
    }

    .front{
      transform:rotateY(0);
      display:flex;flex-direction:column;
    }
    .cover{
      flex:1;background:var(--glass);display:flex;align-items:center;justify-content:center;position:relative;
    }
    .cover img{
      width:100%;height:100%;object-fit:cover;display:block;transition:transform .6s ease;
    }
    .card:hover .cover img{ transform:scale(1.03); }

    .meta{
      padding:12px 14px;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
      text-align:right;
    }
    .meta .title{ font-weight:700;color:#222;font-size:1rem;margin-bottom:4px; font-family:'Playfair Display', serif; }
    .meta .author{ color:var(--muted); font-size:0.9rem; margin:0; }

    /* back */
    .back{
      transform:rotateY(180deg);padding:14px;display:flex;align-items:flex-start;justify-content:center;
    }
    .back-inner{ width:100%; height:100%; display:flex; flex-direction:column; gap:8px; align-items:flex-end; }
    .back-inner h4{ margin:0;font-size:1rem;color:#222;text-align:right;font-family:'Playfair Display', serif; }
    .back-inner p{ margin:0;color:var(--muted);font-size:0.95rem;text-align:right;line-height:1.4;overflow:hidden;max-height:6em }

    .actions{ margin-top:auto;width:100%;display:flex;gap:8px;justify-content:flex-start }
    .btn{
      padding:10px 12px;border-radius:10px;font-weight:700;font-size:0.95rem;display:inline-flex;align-items:center;gap:8px;text-decoration:none;
    }
    .btn-download{ background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#fff; box-shadow:0 8px 20px rgba(120,120,120,0.08); }
    .btn-view{ background:transparent;border:1px solid rgba(0,0,0,0.06); color:var(--muted); }

    /* reorder controls */
    .reorder{
      display:flex;gap:6px;align-items:center;justify-content:flex-end;
    }
    .tiny{
      font-size:12px;padding:6px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);background:rgba(255,255,255,0.6);
      color:#222;cursor:pointer;
    }

    /* More control */
    .more-bar{ display:flex;justify-content:center;padding:14px 0; gap:12px }
    .more-btn{
      background:transparent;padding:10px 16px;border-radius:12px;border:1px solid rgba(0,0,0,0.06);
      background:linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.95));
      box-shadow:0 8px 22px rgba(23,23,23,0.04);
      font-weight:700;color:#222;cursor:pointer;
    }

    /* responsive */
    @media (max-width:1100px){ .books-grid{ grid-template-columns:repeat(3,1fr); } }
    @media (max-width:820px){ .books-grid{ grid-template-columns:repeat(2,1fr); } .logo{ width:56px;height:56px } }
    @media (max-width:480px){ .books-grid{ grid-template-columns:1fr; } .site-title{ font-size:1.2rem } }

    /* entrance */
    .books-grid .card{ opacity:0; transform:translateY(8px); animation:fadeUp .5s ease forwards; }
    .books-grid .card:nth-child(1){ animation-delay:.06s } .books-grid .card:nth-child(2){ animation-delay:.12s }
    .books-grid .card:nth-child(3){ animation-delay:.18s } .books-grid .card:nth-child(4){ animation-delay:.24s }
    @keyframes fadeUp { to{ opacity:1; transform:none } }

    /* drag feedback */
    .dragging{ opacity:0.55; transform:scale(.995); box-shadow:0 18px 40px rgba(0,0,0,0.08) !important; }
    .drop-target{ outline: 3px dashed rgba(123,127,134,0.18); outline-offset:6px; }
  </style>
</head>
<body>
  <div class="container" id="app">
    <header class="header">
      <div class="brand">
        <div class="logo">DW</div>
        <div class="titles">
          <h1 class="site-title">DEEN WAY Ebook</h1>
          <p class="site-sub">منصة كتب إلكترونية أنيقة</p>
        </div>
      </div>
      <div class="toolbar" aria-hidden="true"></div>
    </header>

    <div class="grid-wrap">
      <section id="booksGrid" class="books-grid" aria-live="polite"></section>

      <div class="more-bar" id="moreBar">
        <button id="moreBtn" class="more-btn" aria-expanded="false">عرض المزيد</button>
      </div>
    </div>
  </div>

  <script>
    // عدّل هذه المصفوفة لإضافة / تحرير الكتب (العنوان، المؤلف، الوصف، coverPath، pdfPath)
    // يمكنك وضع مسارات محلية مثل 'assets/cover1.jpg' أو روابط خارجية كاملة.
    const initialBooks = [
      { title:'الطريق الأول', author:'د. أحمد', description:'مقدمة واضحة حول منهجية الحياة.', coverPath:'', pdfPath:'' },
      { title:'نور المعرفة', author:'سلمى', description:'مجموعة أفكار وتوجيهات يومية.', coverPath:'', pdfPath:'' },
      { title:'سبل الدعوة', author:'د. خالد', description:'دليل مختصر للخطاب المؤثر.', coverPath:'', pdfPath:'' },
      { title:'حكمة وإيمان', author:'فهد', description:'خواطر تربوية وروحية.', coverPath:'', pdfPath:'' },
      { title:'بصائر', author:'ليلى', description:'مقالات قصيرة في السلوك والأخلاق.', coverPath:'', pdfPath:'' },
      { title:'رحلة مؤمن', author:'يوسف', description:'سيرة روحانية ونصائح عملية.', coverPath:'', pdfPath:'' },
      { title:'قواعد التغيير', author:'منى', description:'خطوات عملية لتطوير الذات.', coverPath:'', pdfPath:'' },
      { title:'نور على نور', author:'إبراهيم', description:'تأملات قصيرة وعميقة.', coverPath:'', pdfPath:'' }
    ];

    // try to load saved books from localStorage (reorders or edits)
    const STORAGE_KEY = 'dw_books_data_v1';
    let books = loadSaved() || initialBooks.slice(); // copy

    // pagination: number to show initially and per "more" click
    const CHUNK = 4;
    let visibleCount = Math.min(CHUNK, books.length);

    const grid = document.getElementById('booksGrid');
    const moreBtn = document.getElementById('moreBtn');
    const moreBar = document.getElementById('moreBar');

    // generate fallback cover (Data URI SVG)
    function defaultCoverDataURI(title = 'غلاف الكتاب') {
      const safe = escapeXml(title || '');
      const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='600' height='800'>
        <rect width='100%' height='100%' fill='#f6f4f2'/>
        <rect x='20' y='20' width='560' height='760' rx='10' fill='#ffffff' stroke='#efe7e4'/>
        <text x='50%' y='52%' dominant-baseline='middle' text-anchor='middle' fill='#b78f4a' font-size='30' font-family='Playfair Display, serif'>${safe}</text>
      </svg>`;
      return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
    }

    function escapeXml(s=''){ return String(s).replace(/[<>&'"]/g, c => ({'<':'&lt;','>':'&gt;','&':'&amp;',"'":'&apos;','"':'&quot;'}[c])); }

    function render() {
      grid.innerHTML = '';
      const slice = books.slice(0, visibleCount);
      slice.forEach((b, i) => {
        const idx = i; // index within visible slice; but for drag we store global index
        const globalIndex = i; // we'll compute correct index via attribute later
        const article = document.createElement('article');
        article.className = 'card';
        article.draggable = true;
        article.setAttribute('data-index', i); // temporary index; will be updated when re-rendering
        article.tabIndex = 0;
        article.setAttribute('aria-label', b.title || 'كتاب');

        const inner = document.createElement('div'); inner.className = 'card-inner';

        // front
        const front = document.createElement('div'); front.className = 'face front';
        const cover = document.createElement('div'); cover.className = 'cover';
        const img = document.createElement('img');
        img.alt = b.title || 'غلاف';
        img.src = (b.coverPath && b.coverPath.trim()) ? b.coverPath : defaultCoverDataURI(b.title || 'غلاف الكتاب');
        cover.appendChild(img);

        const meta = document.createElement('div'); meta.className = 'meta';
        const t = document.createElement('div'); t.className='title'; t.textContent = b.title || '';
        const a = document.createElement('div'); a.className='author'; a.textContent = b.author || '';
        meta.appendChild(t); meta.appendChild(a);

        // back
        const back = document.createElement('div'); back.className = 'face back';
        const backInner = document.createElement('div'); backInner.className = 'back-inner';
        const h4 = document.createElement('h4'); h4.textContent = b.title || '';
        const p = document.createElement('p'); p.textContent = b.description || '';

        const actions = document.createElement('div'); actions.className='actions';
        const download = document.createElement('a'); download.className='btn btn-download'; download.textContent='⤓ تحميل';
        if (b.pdfPath && b.pdfPath.trim()) {
          download.href = b.pdfPath; download.target='_blank'; download.setAttribute('download','');
        } else {
          download.href = '#'; download.setAttribute('aria-disabled','true');
          download.addEventListener('click', e => { e.preventDefault(); alert('لم يتم إضافة رابط التحميل لهذا الكتاب.'); });
        }

        const view = document.createElement('a'); view.className='btn btn-view'; view.textContent='معاينة';
        if (b.pdfPath && b.pdfPath.trim()) { view.href = b.pdfPath; view.target='_blank'; }
        else { view.href='#'; view.setAttribute('aria-disabled','true'); view.addEventListener('click', e=>{ e.preventDefault(); alert('لم يتم إضافة رابط المعاينة لهذا الكتاب.'); }); }

        actions.appendChild(download); actions.appendChild(view);

        // reorder tiny buttons (up/down)
        const reorder = document.createElement('div'); reorder.className='reorder';
        const up = document.createElement('button'); up.className='tiny'; up.type='button'; up.title='نقل للأعلى'; up.innerHTML='▲';
        const down = document.createElement('button'); down.className='tiny'; down.type='button'; down.title='نقل للأسفل'; down.innerHTML='▼';
        reorder.appendChild(up); reorder.appendChild(down);

        // event listeners for up/down (operate on global books array)
        up.addEventListener('click', () => {
          const globalIdx = getGlobalIndex(article);
          if (globalIdx > 0) { swapBooks(globalIdx, globalIdx - 1); save(); render(); }
        });
        down.addEventListener('click', () => {
          const globalIdx = getGlobalIndex(article);
          if (globalIdx < books.length - 1) { swapBooks(globalIdx, globalIdx + 1); save(); render(); }
        });

        backInner.appendChild(h4); backInner.appendChild(p); backInner.appendChild(actions); backInner.appendChild(reorder);
        back.appendChild(backInner);

        front.appendChild(cover); front.appendChild(meta);
        inner.appendChild(front); inner.appendChild(back);
        article.appendChild(inner);

        // drag & drop handlers
        article.addEventListener('dragstart', (e) => {
          article.classList.add('dragging');
          e.dataTransfer.setData('text/plain', getGlobalIndex(article)); // store global index
          // allow move
          e.dataTransfer.effectAllowed = 'move';
        });
        article.addEventListener('dragend', () => {
          article.classList.remove('dragging');
          document.querySelectorAll('.card').forEach(c => c.classList.remove('drop-target'));
        });
        article.addEventListener('dragover', (e) => {
          e.preventDefault();
          article.classList.add('drop-target');
          e.dataTransfer.dropEffect = 'move';
        });
        article.addEventListener('dragleave', () => { article.classList.remove('drop-target'); });
        article.addEventListener('drop', (e) => {
          e.preventDefault();
          article.classList.remove('drop-target');
          const fromStr = e.dataTransfer.getData('text/plain');
          if (!fromStr) return;
          const from = Number(fromStr);
          const to = getGlobalIndex(article);
          if (Number.isNaN(from) || Number.isNaN(to) || from === to) return;
          moveBook(from, to);
          save();
          render();
        });

        grid.appendChild(article);
      });

      // update more button visibility/text
      if (visibleCount >= books.length) {
        moreBtn.textContent = 'إظهار أقل';
        moreBtn.setAttribute('aria-expanded','true');
      } else {
        moreBtn.textContent = 'عرض المزيد';
        moreBtn.setAttribute('aria-expanded','false');
      }

      // re-assign data-index attributes to reflect global indices (important after reorder)
      Array.from(grid.children).forEach((el, i) => {
        // compute global index by finding the element's title in books slice
        // here we assign data-index via its position in DOM relative to overall books array
        // simpler: set attribute to index in books for first visibleCount items
        el.setAttribute('data-index', i);
      });
    }

    // helpers to get global index of a rendered card element
    function getGlobalIndex(cardEl) {
      // determine index by matching title+author to find in books array
      const title = cardEl.querySelector('.title')?.textContent || '';
      const author = cardEl.querySelector('.author')?.textContent || '';
      for (let i = 0; i < books.length; i++) {
        if ((books[i].title || '') === title && (books[i].author || '') === author) return i;
      }
      // fallback: use data-index attribute if matching failed
      const attr = cardEl.getAttribute('data-index');
      return attr ? Number(attr) : 0;
    }

    function swapBooks(i, j) {
      if (i < 0 || j < 0 || i >= books.length || j >= books.length) return;
      const tmp = books[i]; books[i] = books[j]; books[j] = tmp;
    }

    function moveBook(from, to) {
      if (from === to) return;
      const item = books.splice(from, 1)[0];
      books.splice(to, 0, item);
    }

    // "more" button behaviour: toggle expand/collapse or load next chunk
    moreBtn.addEventListener('click', () => {
      if (visibleCount >= books.length) {
        visibleCount = Math.min(CHUNK, books.length);
        // smooth scroll to top of grid
        grid.scrollIntoView({behavior:'smooth', block:'start'});
      } else {
        visibleCount = Math.min(visibleCount + CHUNK, books.length);
      }
      render();
    });

    // persistence
    function save() { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(books)); } catch(e){} }
    function loadSaved() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        if (Array.isArray(parsed)) return parsed;
        return null;
      } catch(e){ return null; }
    }

    // initial render
    document.addEventListener('DOMContentLoaded', () => {
      render();
    });

    // expose simple API on window for convenience (optional)
    window.DEENWAY = {
      getBooks: () => books,
      setBooks: (arr) => { if (Array.isArray(arr)) { books = arr; visibleCount = Math.min(CHUNK, books.length); save(); render(); } },
      save, loadSaved
    };
  </script>
</body>
</html>
